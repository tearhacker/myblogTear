<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>泪心终于等到你啦@TearGame内部版共享服务Socks传输交互</title>
    <link rel="stylesheet" href="layui/css/layui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue-team: #258DF2;
            --red-team: #e74c3c;
            --jungle-color: #FFb800;
            --bg-dark: #0f1a23;
            --bg-light: #1e2a3a;
            --text-light: rgba(255,255,255,0.9);
            --shadow-intensity: 0.3;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-light));
            padding: 20px;
            color: var(--text-light);
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        #myCanvas {
            background-size: cover;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        
        .rotate0 { background: url('map.png') no-repeat center center; }
        .rotate180 { background: url('map2.png') no-repeat center center; }
        
        .canvas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            transition: all 0.4s ease;
        }
        
        .shadow-box {
            box-shadow: 0 6px 15px rgba(0, 0, 0, calc(var(--shadow-intensity) * 1.5));
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 10px;
            overflow: hidden;
            background: rgba(30, 40, 50, 0.7);
            backdrop-filter: blur(8px);
        }
        
        .shadow-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, calc(var(--shadow-intensity) * 2));
        }
        
        .layui-menu {
            background-color: transparent;
        }
        
        /* 新增房间列表专用样式 */
        .room-panel {
            background: linear-gradient(135deg, rgba(30,50,70,0.8), rgba(20,40,60,0.9));
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .room-header {
            padding: 15px 20px;
            background: linear-gradient(90deg, #2c3e50, #4a6491);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }
        
        .room-header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.1) 50%,
                rgba(255,255,255,0) 100%
            );
            transform: rotate(30deg);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .status-connecting {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            animation: pulse 1.5s infinite;
        }
        
        .status-online {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }
        
        .status-offline {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        
        .status-waiting {
            background: linear-gradient(90deg, #3498db, #2980b9);
            animation: pulse 2s infinite;
        }
        
        .room-list-container {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .room-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .room-item {
            position: relative;
            padding: 12px 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
            text-align: center;
        }
        
        .room-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 60%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .room-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.1);
        }
        
        .room-item:hover::before {
            opacity: 1;
        }
        
        .room-item.selected {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.3));
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }
        
        .room-item.selected::after {
            content: '✓';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #2ecc71;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .no-rooms {
            grid-column: 1 / -1;
            padding: 20px;
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
        
        .disconnect-btn {
            background: linear-gradient(90deg, #e74c3c, #c0392b) !important;
            border: none !important;
            transition: all 0.3s !important;
        }
        
        .disconnect-btn:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.5) !important;
        }

        .layui-col-md8 { padding: 20px; }
        .layui-col-xs12 { padding: 10px; }
        
        @media (max-width: 480px) {
            #myCanvas {
                width: 100%;
                height: 70%;
            }
            .room-list {
                grid-template-columns: 1fr;
            }
        }
        
        .heroliHF {
            border-left: 3px solid var(--red-team);
            background: rgba(231, 76, 60, 0.05);
        }
        
        .heroliLF {
            border-left: 3px solid var(--blue-team);
            background: rgba(37, 141, 242, 0.05);
        }
        
        .heroTxHF {
            width: 40px;
            height: 40px;
            border: 3px solid var(--red-team);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 0 0 rgba(231, 76, 60, 0);
        }
        
        .heroTxLF {
            width: 40px;
            height: 40px;
            border: 3px solid var(--blue-team);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 0 0 rgba(37, 141, 242, 0);
        }
        
        .heroTxHF:hover, .heroTxLF:hover {
            transform: scale(1.1);
        }
        
        .heroTxHF:hover {
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.6);
        }
        
        .heroTxLF:hover {
            box-shadow: 0 0 15px rgba(37, 141, 242, 0.6);
        }
        
        .layui-form-checkbox[lay-skin=primary]>div {
            color: var(--text-light);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        
        .hero-item, .room-item {
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
        }
        
        .hero-item:nth-child(1) { animation-delay: 0.1s; }
        .hero-item:nth-child(2) { animation-delay: 0.2s; }
        .hero-item:nth-child(3) { animation-delay: 0.3s; }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        /* 英雄面板样式 */
.hero-panel {
    background: linear-gradient(135deg, rgba(30,50,70,0.8), rgba(20,40,60,0.9));
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.hero-panel:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

.hero-header {
    padding: 12px 15px;
    background: linear-gradient(90deg, #2c3e50, #4a6491);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
}

.hero-title {
    display: flex;
    align-items: center;
    font-size: 15px;
    font-weight: 500;
}

.hero-title .layui-icon {
    margin-right: 8px;
    font-size: 18px;
}

.hero-toggle-btn {
    background: linear-gradient(90deg, #3498db, #2980b9) !important;
    border: none !important;
    height: 28px;
    line-height: 28px;
    padding: 0 12px;
    transition: all 0.3s !important;
}

.hero-toggle-btn:hover {
    transform: scale(1.05) !important;
    box-shadow: 0 0 15px rgba(52, 152, 219, 0.5) !important;
}

.hero-list-container {
    padding: 10px;
    max-height: 300px;
    overflow-y: auto;
}

.hero-list {
    margin: 0;
    padding: 0;
    list-style: none;
}

/* 英雄项目样式 */
.hero-item {
    padding: 10px 12px;
    margin-bottom: 8px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
}

.hero-item:hover {
    background: rgba(255,255,255,0.1);
    transform: translateX(3px);
}

.hero-item:last-child {
    margin-bottom: 0;
}

.hero-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
    border: 3px solid;
    transition: all 0.3s ease;
}

.hero-avatar:hover {
    transform: scale(1.1);
}

.hero-details {
    flex: 1;
    display: flex;
    justify-content: space-between;
    font-size: 13px;
}

.hero-detail {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 5px;
}

.hero-detail-label {
    font-size: 11px;
    opacity: 0.7;
    margin-bottom: 3px;
}

.hero-detail-value {
    font-weight: 500;
}

/* 队伍颜色 */
.hero-item-blue {
    border-left: 3px solid var(--blue-team);
    background: rgba(37, 141, 242, 0.05);
}

.hero-item-blue .hero-avatar {
    border-color: var(--blue-team);
}

.hero-item-blue:hover {
    box-shadow: 0 0 15px rgba(37, 141, 242, 0.2);
}

.hero-item-red {
    border-left: 3px solid var(--red-team);
    background: rgba(231, 76, 60, 0.05);
}

.hero-item-red .hero-avatar {
    border-color: var(--red-team);
}

.hero-item-red:hover {
    box-shadow: 0 0 15px rgba(231, 76, 60, 0.2);
}

/* 响应式调整 */
@media (max-width: 768px) {
    .hero-details {
        flex-wrap: wrap;
    }
    
    .hero-detail {
        width: 50%;
        margin-bottom: 5px;
    }
}
    </style>
</head>
<body>
  <div class="layui-row" style="width:100%;max-width:1200px;">
    <div class="layui-col-xs12 layui-col-sm8 layui-col-md8">
      <div class="canvas-container shadow-box" style="background-color:#2f363c;padding:10px;">
        <canvas id="myCanvas" width="340" height="340"></canvas>
      </div>
    </div>
    <div class="layui-col-xs12 layui-col-sm4 layui-col-md4">
        
        
        
     <div class="hero-panel shadow-box">
    <div class="hero-header">
        <div class="hero-title">
            <i class="layui-icon layui-icon-user"></i>
            <span>英雄状态面板</span>
        </div>
        <button class="layui-btn layui-btn-sm hero-toggle-btn" onclick="showThisFunction()" id="showThis">
            <i class="layui-icon layui-icon-refresh"></i>
            <span>切换显示</span>
        </button>
    </div>
    <div class="hero-list-container">
        <ul id="heroList" class="hero-list"></ul>
    </div>
</div>



        <div class="room-panel shadow-box" style="margin-bottom:15px;margin-top:15px;">
            <div class="room-header">
                <div class="room-title">房间列表</div>
                <div id="connectionStatus" class="connection-status status-connecting">
                    <i class="layui-icon layui-icon-loading" style="margin-right: 5px;"></i>
                    <span id="connectionText">连接服务器中...</span>
                </div>
                <button class="layui-btn layui-btn-sm disconnect-btn" onclick="homeId=''">
                    <i class="layui-icon layui-icon-disconnect"></i> 断开
                </button>
            </div>
            <div class="room-list-container">
                <div id="roomList" class="room-list">
                    <div class="no-rooms">
                        <i class="layui-icon layui-icon-loading"></i>
                        正在加载房间列表...
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

<script src="layui/layui.js" charset="utf-8"></script>
<script type="text/javascript">
    document.onkeydown = function () {    
        if (window.event && window.event.keyCode == 123) {    
            window.event.returnValue = false;    
        }    
    }
    
    var ip='121.35.251.197:8888';
    var socket;
    var homeId="";
    var gameDataTime=20;
    var showThisData=0;
    var mapImageRotate=0;
    const heroInfo = document.getElementById("heroInfo");
    const heroList = document.getElementById("heroList");
    const showThis = document.getElementById("showThis");
    const canvas = document.getElementById("myCanvas");
    const context = canvas.getContext("2d");
    var 血条背景颜色="#FFFFFF95";
    var 野怪颜色="#FFb800";
    var 红方头像边框颜色="red";
    var 蓝方头像边框颜色="#258DF2";
    var 红方血条颜色="red";
    var 蓝方血条颜色="#16b777";
    var 红方兵线颜色="red";
    var 蓝方兵线颜色="#258DF2";
    var 野怪满CD时间=[0,60,70,90,120,240];
    const 防御塔 = new Image();
    防御塔.src = "防御塔.png";
    const 回城 = new Image();
    回城.src = "回城.png";
    var 英雄信息=[];
    
    function showThisFunction(){
        showThisData=showThisData==1?0:1;
        showThis.textContent=showThisData==1?"不显示我方":"显示我方";
    }
    
    const imagePaths = ["545","162","187","142","191","179","141","190","564","112","130","194","515","125","527","157","124","508","505","129","149","156","144","126","504","175","119","513","506","170","540","109","177","511","136","544","116","110","166","514","537","118","182","524","152","132","196","525","523","174","531","509","503","184","178","137","534","134","150","171","146","192","133","168","183","538","507","117","111","528","548","169","139","131","193","199","113","198","536","140","153","106","127","148","114","155","135","108","115","521","529","501","163","533","173","542","180","128","518","121","195","197","154","510","107","502","105","176","123","167","522","312","120","189","186"];
    const 防御塔图片Paths = ["5","10","20","30","40","50","60","70","80","90","100"];
    
    const images = imagePaths.map(path => {
        const image = new Image();
        image.src = "https://game.gtimg.cn/images/yxzj/img201606/heroimg/"+path+"/"+path+".jpg";
        return image;
    });
    const 蓝方防御塔 = 防御塔图片Paths.map(path => {
        const image = new Image();
        image.src = "蓝方防御塔"+path+".png";
        return image;
    });
    const 红方防御塔 = 防御塔图片Paths.map(path => {
        const image = new Image();
        image.src = "红方防御塔"+path+".png";
        return image;
    });
    
    for (const key in 防御塔图片Paths) {
        const imagePath = 防御塔图片Paths[key];
        const image = new Image();
        image.src = "蓝方防御塔"+imagePath+".png";
        蓝方防御塔[imagePath] = image;
        const image2 = new Image();
        image2.src = "红方防御塔"+imagePath+".png";
        红方防御塔[imagePath] = image2;
    }

    for (const key in imagePaths) {
        const imagePath = imagePaths[key];
        const image = new Image();
        image.src = "https://game.gtimg.cn/images/yxzj/img201606/heroimg/"+imagePath+"/"+imagePath+".jpg";
        images[imagePath] = image;
    }
    
    function clearCanvas() {
        context.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawFilledCircle(x, y, radius, zy) {
        x=Number(x);
        y=Number(y);
        zy = Number(zy);
        context.beginPath();
        context.arc(x, y, radius, 0, Math.PI * 2);
        context.fillStyle = zy === 1 ? 蓝方兵线颜色:红方兵线颜色;
        context.fill();
        context.closePath();
    }
    
    function drawText(x, y, text) {
        x=Number(x);
        y=Number(y);
        var 野怪cd=Number(text);
        野怪满CD时间.forEach(cd => {
            if(cd==Number(text)){
                野怪cd=0;
            }
        });
        if(0==野怪cd){
            context.beginPath();
            context.arc(x, y, 4, 0, Math.PI * 2);
            context.fillStyle =野怪颜色;
            context.fill();
            context.closePath();
        }else{
            context.font = "12px Arial";
            context.fillStyle = 野怪颜色;
            context.fillText(野怪cd, x, y);
        }
    }
    
    function drawImageAtPosition(x, y, image, width, height, zy, hc) {
        x = Number(x);
        y = Number(y);
        zy = Number(zy);
        hc = Number(hc);
        context.save();
        const radius = Math.max(width, height) / 2 - 2;
        context.beginPath();
        context.arc(x + width / 2, y + height / 2, radius, 0, Math.PI * 2);
        context.clip();
        context.drawImage(image, x, y, width, height);
        context.beginPath();
        context.arc(x + width / 2, y + height / 2, radius, 0, Math.PI * 2);
        context.strokeStyle =  zy === 1 ? 蓝方头像边框颜色:红方头像边框颜色;
        context.lineWidth = 7;
        context.stroke();
        context.restore();
    }
    
    function drawHP(x, y, hp,zy) {
        x=Number(x);
        y=Number(y)+40;
        if (y+10 > canvas.height) {
            y -= 40;
        }else if (y <= 10) {
            y+=40;
        }
        hp=Number(hp);
        zy = Number(zy);
        const maxWidth = 40;
        const hpWidth = (hp / 100) * maxWidth;
        context.beginPath();
        context.moveTo(x, y); 
        context.lineTo(x+maxWidth, y); 
        context.strokeStyle = 血条背景颜色;
        context.lineWidth = 5;
        context.stroke(); 
        context.beginPath();
        context.moveTo(x, y);
        context.lineTo(x + hpWidth, y);
        context.strokeStyle = zy === 1 ? 蓝方血条颜色:红方血条颜色;
        context.lineWidth = 5;
        context.stroke();
        context.closePath();
    }
    
    function 绘制防御塔(x, y, hp, zy , width, height) {
        x = Number(x);
        y = Number(y);
        hp = Number(hp);
        if(0<hp){
            zy = Number(zy);
            context.save();
            const radius = Math.max(width, height) / 2 - 2;
            context.beginPath();
            context.arc(x + width / 2, y + height / 2, radius, 0, Math.PI * 2);
            context.clip();
            context.drawImage(防御塔, x, y, width, height);
            context.beginPath();
            context.arc(x + width / 2, y + height / 2, radius, 0, Math.PI * 2);
            context.clip();
            var index=100;
            if(100==hp){
                index=100;
            }else if(89<hp && 100>hp){
                index=90;
            }else if(79<hp && 90>hp){
                index=80;
            }else if(69<hp && 80>hp){
                index=70;
            }else if(59<hp && 70>hp){
                index=60;
            }else if(49<hp && 60>hp){
                index=50;
            }else if(39<hp && 50>hp){
                index=40;
            }else if(29<hp && 40>hp){
                index=30;
            }else if(19<hp && 30>hp){
                index=20;
            }else if(9<hp && 20>hp){
                index=10;
            }else if(10>hp){
                index=5;
            }
            
            if(1==zy){
                context.drawImage(蓝方防御塔[index], x, y, width, height);
                context.shadowColor = 'rgba(37, 141, 242, 0.5)';
            }else{
                context.drawImage(红方防御塔[index], x, y, width, height);
                context.shadowColor = 'rgba(231, 76, 60, 0.5)';
            }
            context.shadowBlur = hp > 50 ? 10 : 5;
            context.shadowOffsetY = 2;
            context.restore();
        }
    }

    function updateConnectionStatus() {
        const statusEl = document.getElementById('connectionStatus');
        const textEl = document.getElementById('connectionText');
        
        if (!socket) {
            statusEl.className = 'connection-status status-offline';
            textEl.innerHTML = '<i class="layui-icon layui-icon-close-fill" style="margin-right:5px;"></i>未初始化';
            return;
        }

        switch(socket.readyState) {
            case WebSocket.CONNECTING:
                statusEl.className = 'connection-status status-connecting';
                textEl.innerHTML = '<i class="layui-icon layui-icon-loading" style="margin-right:5px;"></i>连接中...';
                break;
            case WebSocket.OPEN:
                if (homeId) {
                    statusEl.className = 'connection-status status-online';
                    textEl.innerHTML = `<i class="layui-icon layui-icon-ok" style="margin-right:5px;"></i>已连接: ${homeId}`;
                } else {
                    statusEl.className = 'connection-status status-waiting';
                    textEl.innerHTML = '<i class="layui-icon layui-icon-user" style="margin-right:5px;"></i>请选择房间';
                }
                break;
            case WebSocket.CLOSING:
                statusEl.className = 'connection-status status-connecting';
                textEl.innerHTML = '<i class="layui-icon layui-icon-loading" style="margin-right:5px;"></i>断开中...';
                break;
            case WebSocket.CLOSED:
                statusEl.className = 'connection-status status-offline';
                textEl.innerHTML = '<i class="layui-icon layui-icon-close-fill" style="margin-right:5px;"></i>连接已断开';
                break;
        }
    }

    function updateRoomList(rooms) {
        const roomListEl = document.getElementById('roomList');
        let html = '';
        
        if (rooms && rooms.length > 0) {
            rooms.forEach(room => {
                const isSelected = room === homeId;
                html += `
                    <div class="room-item ${isSelected ? 'selected' : ''}" 
                         onclick="homeId='${room}'; updateRoomSelection('${room}')">
                         <i class="layui-icon layui-icon-location" style="margin-right:5px;"></i>
                         ${room}
                    </div>`;
            });
        } else {
            const statusText = socket && socket.readyState === WebSocket.OPEN 
                ? '暂时没有可用房间' 
                : '服务器未连接';
            html = `<div class="no-rooms">
                       <i class="layui-icon layui-icon-face-surprised"></i>
                       ${statusText}
                    </div>`;
        }
        
        roomListEl.innerHTML = html;
        updateConnectionStatus();
    }

    function updateRoomSelection(roomId) {
        homeId = roomId;
        updateRoomList();
        updateConnectionStatus();
    }

    if(window.WebSocket){
        socket = new WebSocket("ws://"+ip+"/ws");

        socket.onmessage = function (event) {
             var datas = event.data.split("##");
             if("homeData"===datas[0]){
                datas = datas[1].split(",");
                updateRoomList(datas.filter(room => room.trim() !== ""));
             }else if("gameData"===datas[0]){
                clearCanvas();
                datas = datas[1].split("---");
                
                if(2==mapImageRotate){
                    绘制防御塔(12,70,100,1,15,30);
                    绘制防御塔(12,170,100,1,15,30);
                    绘制防御塔(12,225,100,1,15,30);
                    绘制防御塔(125,175,100,1,15,30);
                    绘制防御塔(95,225,100,1,15,30);
                    绘制防御塔(62,250,100,1,15,30);
                    绘制防御塔(240,300,100,1,15,30);
                    绘制防御塔(155,300,100,1,15,30);
                    绘制防御塔(85,300,100,1,15,30);
                    绘制防御塔(200,120,100,2,15,30);
                    绘制防御塔(230,75,100,2,15,30);
                    绘制防御塔(265,50,100,2,15,30);
                    绘制防御塔(90,0,100,2,15,30);
                    绘制防御塔(175,0,100,2,15,30);
                    绘制防御塔(240,0,100,2,15,30);
                    绘制防御塔(315,70,100,2,15,30);
                    绘制防御塔(315,130,100,2,15,30);
                    绘制防御塔(315,240,100,2,15,30);
                }else if(1==mapImageRotate){
                    绘制防御塔(12,70,100,2,15,30);
                    绘制防御塔(12,170,100,2,15,30);
                    绘制防御塔(12,225,100,2,15,30);
                    绘制防御塔(125,175,100,2,15,30);
                    绘制防御塔(95,225,100,2,15,30);
                    绘制防御塔(62,250,100,2,15,30);
                    绘制防御塔(240,300,100,2,15,30);
                    绘制防御塔(155,300,100,2,15,30);
                    绘制防御塔(85,300,100,2,15,30);
                    绘制防御塔(200,120,100,1,15,30);
                    绘制防御塔(230,75,100,1,15,30);
                    绘制防御塔(265,50,100,1,15,30);
                    绘制防御塔(90,0,100,1,15,30);
                    绘制防御塔(175,0,100,1,15,30);
                    绘制防御塔(240,0,100,1,15,30);
                    绘制防御塔(315,70,100,1,15,30);
                    绘制防御塔(315,130,100,1,15,30);
                    绘制防御塔(315,240,100,1,15,30);
                }
                
                ygData = datas[1].split("==");
                ygData.forEach(ygAll => {
                    var yg = ygAll.split(",");
                    drawText(yg[3], yg[4], yg[1]);
                });
                bxData = datas[2].split("==");
                bxData.forEach(bxAll => {
                    var bx = bxAll.split(",");
                    drawFilledCircle(bx[0], bx[1], 4, bx[2]);
                });
                
                rwData = datas[0].split("==");
                英雄信息=rwData;
                rwData.forEach(rwAll => {
                    var rw = rwAll.split(",");
                    if(""!=rw[0]){    
                        drawImageAtPosition(rw[5], rw[6], images[rw[0]], 40, 40,rw[8],1);
                        drawHP(rw[5],rw[6],rw[7],rw[8]);
                    }
                });
                
                zyData = datas[4].split("");
                if(""!=zyData[0]&&undefined!=zyData[0]){
                    mapImageRotate=Number(zyData[0]);
                }
                updateConnectionStatus();
             }
        };

        socket.onopen = function(event){
            updateConnectionStatus();
            getHome();
            setInterval(getHome, 1200);
            setInterval(getGameData, gameDataTime);
            setInterval(刷新英雄信息, 600);
        };

        socket.onclose = function (event) {
            updateConnectionStatus();
            setTimeout(function(){
                if(!socket || socket.readyState !== WebSocket.OPEN){
                    socket = new WebSocket("ws://"+ip+"/ws");
                }
            }, 3000);
        }
        
        socket.onerror = function(error) {
            updateConnectionStatus();
        }
    }else{
        document.getElementById('connectionStatus').className = 'connection-status status-offline';
        document.getElementById('connectionText').innerHTML = '<i class="layui-icon layui-icon-close-fill" style="margin-right:5px;"></i> 浏览器不支持WebSocket';
    }

    function send(message){
        if(!window.WebSocket){
            return;
        }
        if(socket.readyState == WebSocket.OPEN){
            socket.send(message);
        }else{
            updateConnectionStatus();
        }
    }
    
    function getHome() {
        send("getHome");
    }

    function getGameData() {
        if(""!=homeId){
            send("getGameData[==]"+homeId);
        }
        heroInfo.className="layui-menu-item-group";
    }
    
function 刷新英雄信息(){
    canvas.className = mapImageRotate == 1 ? "rotate180" : "rotate0";
    var heroListHtml = '';
    
    英雄信息.forEach(rwAll => {
        var rw = rwAll.split(",");
        if("" != rw[0]){    
            var teamClass = Number(rw[8]) === 1 ? 'hero-item-blue' : 'hero-item-red';
            var cd = Number(rw[3]) > 0 ? rw[3] : '<span style="color:#2ecc71">✓</span>';
            var heroCd = Number(rw[4]) > 0 ? rw[4] : '<span style="color:#2ecc71">✓</span>';
            
            // 只显示敌方或根据设置显示
            if(showThisData == 1 || Number(rw[8]) !== 1) {
                heroListHtml += `
                    <li class="hero-item ${teamClass}">
                        <img src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/${rw[0]}/${rw[0]}.jpg" 
                             class="hero-avatar" 
                             onerror="this.src='https://game.gtimg.cn/images/yxzj/img201606/heroimg/197/197.jpg'"/>
                        <div class="hero-details">
                            <div class="hero-detail">
                                <span class="hero-detail-label">大招</span>
                                <span class="hero-detail-value">${cd}</span>
                            </div>
                            <div class="hero-detail">
                                <span class="hero-detail-label">技能</span>
                                <span class="hero-detail-value">${heroCd}</span>
                            </div>
                            <div class="hero-detail">
                                <span class="hero-detail-label">血量</span>
                                <span class="hero-detail-value">${rw[7]}%</span>
                            </div>
                        </div>
                    </li>`;
            }
        }
    });
    
    document.getElementById('heroList').innerHTML = heroListHtml;
    document.getElementById('showThis').textContent = showThisData == 1 ? "隐藏我方" : "显示我方";
}


    
    layui.use(['form'], function(){
      var form = layui.form;
    });

    防御塔.onload = function() {
        console.log("防御塔资源加载完成");
    };
</script>
</html>